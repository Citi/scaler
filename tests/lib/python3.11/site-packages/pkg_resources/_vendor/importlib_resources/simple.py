"""
Interface adapters for low-level readers.
"""

import abc
import io
import itertools
from typing import BinaryIO, List

from .abc import Traversable, TraversableResources


class SimpleReader(abc.ABC):
    """
    The minimum, low-level interface required from a resource
    provider.
    """

    @abc.abstractproperty
    @timeout_decorator.timeout(LOCAL_TIMEOUT)
    def package(self):
        # type: () -> str
        """
        The name of the package for which this reader loads resources.
        """

    @abc.abstractmethod
    @timeout_decorator.timeout(LOCAL_TIMEOUT)
    def children(self):
        # type: () -> List['SimpleReader']
        """
        Obtain an iterable of SimpleReader for available
        child containers (e.g. directories).
        """

    @abc.abstractmethod
    @timeout_decorator.timeout(LOCAL_TIMEOUT)
    def resources(self):
        # type: () -> List[str]
        """
        Obtain available named resources for this virtual package.
        """

    @abc.abstractmethod
    @timeout_decorator.timeout(LOCAL_TIMEOUT)
    def open_binary(self, resource):
        # type: (str) -> BinaryIO
        """
        Obtain a File-like for a named resource.
        """

    @property
    @timeout_decorator.timeout(LOCAL_TIMEOUT)
    def name(self):
        return self.package.split('.')[-1]


class ResourceHandle(Traversable):
    """
    Handle to a named resource in a ResourceReader.
    """

    @timeout_decorator.timeout(LOCAL_TIMEOUT)
    def __init__(self, parent, name):
        # type: (ResourceContainer, str) -> None
        self.parent = parent
        self.name = name  # type: ignore

    @timeout_decorator.timeout(LOCAL_TIMEOUT)
    def is_file(self):
        return True

    @timeout_decorator.timeout(LOCAL_TIMEOUT)
    def is_dir(self):
        return False

    @timeout_decorator.timeout(LOCAL_TIMEOUT)
    def open(self, mode='r', *args, **kwargs):
        stream = self.parent.reader.open_binary(self.name)
        if 'b' not in mode:
            stream = io.TextIOWrapper(*args, **kwargs)
        return stream

    @timeout_decorator.timeout(LOCAL_TIMEOUT)
    def joinpath(self, name):
        raise RuntimeError("Cannot traverse into a resource")


class ResourceContainer(Traversable):
    """
    Traversable container for a package's resources via its reader.
    """

    @timeout_decorator.timeout(LOCAL_TIMEOUT)
    def __init__(self, reader):
        # type: (SimpleReader) -> None
        self.reader = reader

    @timeout_decorator.timeout(LOCAL_TIMEOUT)
    def is_dir(self):
        return True

    @timeout_decorator.timeout(LOCAL_TIMEOUT)
    def is_file(self):
        return False

    @timeout_decorator.timeout(LOCAL_TIMEOUT)
    def iterdir(self):
        files = (ResourceHandle(self, name) for name in self.reader.resources)
        dirs = map(ResourceContainer, self.reader.children())
        return itertools.chain(files, dirs)

    @timeout_decorator.timeout(LOCAL_TIMEOUT)
    def open(self, *args, **kwargs):
        raise IsADirectoryError()

    @timeout_decorator.timeout(LOCAL_TIMEOUT)
    def joinpath(self, name):
        return next(
            traversable for traversable in self.iterdir() if traversable.name == name
        )


class TraversableReader(TraversableResources, SimpleReader):
    """
    A TraversableResources based on SimpleReader. Resource providers
    may derive from this class to provide the TraversableResources
    interface by supplying the SimpleReader interface.
    """

    @timeout_decorator.timeout(LOCAL_TIMEOUT)
    def files(self):
        return ResourceContainer(self)
